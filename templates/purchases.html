<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Achats</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .alert {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="margin-bottom: 20px;">
                <a href="/" class="btn btn-primary" style="background: linear-gradient(45deg, #2c3e50, #34495e); text-decoration: none; display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    <i class="fas fa-home"></i> üè† Retour √† l'Accueil
                </a>
            </div>
            <h1><i class="fas fa-shopping-bag"></i> Gestion des Achats</h1>
            <p>Enregistrez et suivez vos achats par p√©riode</p>
        </div>
        
        <div class="alert" id="error-alert">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="error-message"></span>
        </div>
        
        <div class="success" id="success-alert">
            <i class="fas fa-check-circle"></i>
            <span id="success-message"></span>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Chargement...</p>
        </div>
        
        <div class="form-container">
            <h2><i class="fas fa-plus"></i> Nouvel Achat</h2>
            
            <!-- Section pour charger les demandes valid√©es -->
            <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <h3 style="margin: 0 0 15px 0; color: #28a745;">
                    <i class="fas fa-shopping-cart"></i> Charger les Demandes Valid√©es
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="service_filter">Service</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="service_filter" onchange="loadValidatedRequests()" style="flex: 1;">
                                <option value="">S√©lectionnez un service pour voir ses demandes valid√©es...</option>
                            </select>
                            <button type="button" onclick="loadServices()" class="btn btn-info" style="padding: 8px 12px; font-size: 12px;" title="Actualiser les services">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="validated-requests-section" style="display: none; margin-top: 15px;">
                    <h4 style="margin: 0 0 15px 0; color: #28a745;">
                        <i class="fas fa-check-circle"></i> Demandes Valid√©es
                    </h4>
                    <div id="validated-requests-list"></div>
                </div>
            </div>
            
            <form id="purchase-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="item_name">Nom de l'article *</label>
                        <input type="text" id="item_name" name="item_name" required>
                    </div>
                    <div class="form-group">
                        <label for="category">Cat√©gorie *</label>
                        <select id="category" name="category" required>
                            <option value="">S√©lectionner une cat√©gorie</option>
                            <option value="office_supplies">Fournitures de Bureau</option>
                            <option value="equipment">√âquipement</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="fuel">Carburant</option>
                            <option value="food">Nourriture</option>
                            <option value="cleaning">Nettoyage</option>
                            <option value="security">S√©curit√©</option>
                            <option value="other">Autre</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="period">P√©riode *</label>
                        <select id="period" name="period" required>
                            <option value="">S√©lectionner une p√©riode</option>
                            <option value="daily">Journalier</option>
                            <option value="weekly">Hebdomadaire</option>
                            <option value="monthly">Mensuel</option>
                            <option value="semestrial">Semestriel</option>
                            <option value="annual">Annuel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supplier">Fournisseur</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="supplier" name="supplier" style="flex: 1;">
                                <option value="">S√©lectionnez un fournisseur...</option>
                            </select>
                            <button type="button" onclick="loadSuppliers()" class="btn btn-info" style="padding: 8px 12px; font-size: 12px;" title="Actualiser la liste">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button type="button" onclick="openSupplierModal()" class="btn btn-success" style="padding: 8px 12px; font-size: 12px;" title="Cr√©er un nouveau fournisseur">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="quantity">Quantit√© *</label>
                        <input type="number" id="quantity" name="quantity" min="1" required>
                    </div>
                    <div class="form-group">
                        <label for="unit_price">Prix unitaire (GNF) *</label>
                        <input type="number" id="unit_price" name="unit_price" step="0.01" min="0" required oninput="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="total">Total (GNF) *</label>
                        <input type="number" id="total" name="total" step="0.01" min="0" readonly style="background-color: #f8f9fa;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="purchase_date">Date d'achat</label>
                    <input type="date" id="purchase_date" name="purchase_date">
                </div>
                
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-save"></i> Enregistrer l'Achat
                </button>
                <button type="button" onclick="clearForm()" class="btn btn-warning">
                    <i class="fas fa-eraser"></i> Effacer
                </button>
            </form>
        </div>
        
        <div class="table-container">
            <h2><i class="fas fa-list"></i> Liste des Achats</h2>
            <div style="margin-bottom: 20px;">
                <button onclick="loadPurchases()" class="btn">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
                <button onclick="exportPurchases()" class="btn btn-warning">
                    <i class="fas fa-download"></i> Exporter
                </button>
            </div>
            <table id="purchases-table">
                <thead>
                    <tr>
                        <th>Article</th>
                        <th>Cat√©gorie</th>
                        <th>P√©riode</th>
                        <th>Quantit√©</th>
                        <th>Prix Unitaire</th>
                        <th>Total</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchases-tbody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Chargement des donn√©es...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let allPurchasesData = []; // Stocker toutes les donn√©es

        // Charger les achats au d√©marrage
        document.addEventListener('DOMContentLoaded', function() {
            loadPurchases();
            loadSuppliers();
            loadServices();
            // D√©finir la date d'aujourd'hui par d√©faut
            document.getElementById('purchase_date').value = new Date().toISOString().split('T')[0];
        });
        
        // Gestion du formulaire
        document.getElementById('purchase-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Calculer le montant total
            const quantity = parseFloat(data.quantity);
            const unitPrice = parseFloat(data.unit_price);
            data.amount = (quantity * unitPrice).toFixed(2);
            
            try {
                showLoading(true);
                hideAlerts();
                
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/purchases/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showSuccess('Achat enregistr√© avec succ√®s !');
                    clearForm();
                    loadPurchases();
                } else {
                    const error = await response.json();
                    showError('Erreur: ' + (error.detail || 'Impossible d\'enregistrer l\'achat'));
                }
            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                showLoading(false);
            }
        });
        
        // Charger la liste des achats
        async function loadPurchases() {
            try {
                showLoading(true);
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/purchases/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const purchases = await response.json();
                allPurchasesData = purchases; // Stocker les donn√©es
                
                const tbody = document.getElementById('purchases-tbody');
                if (purchases.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px;">Aucun achat enregistr√©</td></tr>';
                } else {
                    tbody.innerHTML = purchases.map(purchase => `
                        <tr>
                            <td>${purchase.item_name}</td>
                            <td>${getCategoryLabel(purchase.category)}</td>
                            <td>${getPeriodLabel(purchase.period)}</td>
                            <td>${purchase.quantity}</td>
                        <td>${purchase.unit_price.toLocaleString()} GNF</td>
                        <td>${purchase.amount.toLocaleString()} GNF</td>
                            <td>${new Date(purchase.purchase_date).toLocaleDateString('fr-FR')}</td>
                            <td>
                                <button onclick="viewStockItem(${purchase.id})" class="btn btn-success" style="padding: 5px 10px; font-size: 12px;" title="Voir dans le stock">
                                    <i class="fas fa-boxes"></i>
                                </button>
                                <button onclick="editPurchase(${purchase.id})" class="btn" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deletePurchase(${purchase.id})" class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                showError('Erreur lors du chargement des achats: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        // Fonctions utilitaires
        function getCategoryLabel(category) {
            const labels = {
                'office_supplies': 'Bureau',
                'equipment': '√âquipement',
                'maintenance': 'Maintenance',
                'fuel': 'Carburant',
                'food': 'Nourriture',
                'cleaning': 'Nettoyage',
                'security': 'S√©curit√©',
                'other': 'Autre'
            };
            return labels[category] || category;
        }
        
        function getPeriodLabel(period) {
            const labels = {
                'daily': 'Journalier',
                'weekly': 'Hebdomadaire',
                'monthly': 'Mensuel',
                'semestrial': 'Semestriel',
                'annual': 'Annuel'
            };
            return labels[period] || period;
        }
        
        function clearForm() {
            document.getElementById('purchase-form').reset();
            document.getElementById('purchase_date').value = new Date().toISOString().split('T')[0];
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-alert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('error-alert').style.display = 'none';
            }, 5000);
        }
        
        function showSuccess(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-alert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('success-alert').style.display = 'none';
            }, 3000);
        }
        
        function hideAlerts() {
            document.getElementById('error-alert').style.display = 'none';
            document.getElementById('success-alert').style.display = 'none';
        }
        
        function editPurchase(id) {
            alert('Fonctionnalit√© d\'√©dition en cours de d√©veloppement');
        }
        
        async function deletePurchase(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet achat ?')) {
                try {
                    const response = await fetch(`/api/purchases/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        showSuccess('Achat supprim√© avec succ√®s');
                        loadPurchases();
                    } else {
                        showError('Erreur lors de la suppression');
                    }
                } catch (error) {
                    showError('Erreur: ' + error.message);
                }
            }
        }
        
        async function viewStockItem(purchaseId) {
            try {
                showLoading(true);
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/purchases/${purchaseId}/stock-item`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stockItem = await response.json();
                    showSuccess(`Article trouv√© dans le stock: ${stockItem.name} - Quantit√©: ${stockItem.current_quantity} - Co√ªt: ${stockItem.unit_cost.toLocaleString()} GNF`);
                    // Ouvrir la page stock dans un nouvel onglet
                    window.open('/stock', '_blank');
                } else {
                    showError('Article non trouv√© dans le stock');
                }
            } catch (error) {
                showError('Erreur lors de la recherche: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function exportPurchases() {
            try {
                // Cr√©er un CSV des achats
                const purchases = allPurchasesData || [];
                if (purchases.length === 0) {
                    showError('Aucune donn√©e √† exporter');
                    return;
                }
                
                let csv = 'Article,Cat√©gorie,P√©riode,Quantit√©,Prix Unitaire,Total,Fournisseur,Date\n';
                purchases.forEach(purchase => {
                    csv += `"${purchase.item_name}","${getCategoryLabel(purchase.category)}","${getPeriodLabel(purchase.period)}",${purchase.quantity},${purchase.unit_price},${purchase.amount},"${purchase.supplier || ''}","${new Date(purchase.purchase_date).toLocaleDateString('fr-FR')}"\n`;
                });
                
                // T√©l√©charger le fichier
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `achats_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('Export des achats r√©ussi !');
            } catch (error) {
                showError('Erreur lors de l\'export: ' + error.message);
            }
        }

        async function loadSuppliers() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/suppliers/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const suppliers = await response.json();
                    populateSuppliersSelect(suppliers);
                } else {
                    console.error('Erreur lors du chargement des fournisseurs');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des fournisseurs:', error);
            }
        }

        function populateSuppliersSelect(suppliers) {
            const select = document.getElementById('supplier');
            select.innerHTML = '<option value="">S√©lectionnez un fournisseur...</option>';
            
            suppliers.forEach(supplier => {
                if (supplier.is_active) {
                    const option = document.createElement('option');
                    option.value = supplier.name;
                    option.textContent = `${supplier.name} (${supplier.contact_person})`;
                    select.appendChild(option);
                }
            });
        }

        function openSupplierModal() {
            const modal = createSupplierModal();
            document.body.appendChild(modal);
        }

        function createSupplierModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 15px;
                    max-width: 600px;
                    width: 90%;
                    max-height: 90vh;
                    overflow-y: auto;
                ">
                    <h2><i class="fas fa-truck-loading"></i> Cr√©er un Nouveau Fournisseur</h2>
                    
                    <form id="supplier-modal-form">
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="supplier_name">Nom du Fournisseur *</label>
                                <input type="text" id="supplier_name" name="name" required 
                                       style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label for="contact_person">Personne de Contact</label>
                                <input type="text" id="contact_person" name="contact_person" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="supplier_email">Email</label>
                                <input type="email" id="supplier_email" name="email" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                            </div>
                            <div class="form-group">
                                <label for="supplier_phone">T√©l√©phone</label>
                                <input type="tel" id="supplier_phone" name="phone" 
                                       style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div class="form-group">
                                <label for="supplier_country">Pays</label>
                                <select id="supplier_country" name="country" onchange="loadCities(this.value, 'supplier_city')" 
                                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                                    <option value="">S√©lectionnez un pays...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="supplier_city">Ville</label>
                                <select id="supplier_city" name="city" 
                                        style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;">
                                    <option value="">S√©lectionnez d'abord un pays...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label for="supplier_address">Adresse</label>
                            <textarea id="supplier_address" name="address" rows="3" 
                                      style="width: 100%; padding: 10px; border: 2px solid #e1e8ed; border-radius: 8px;"></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" onclick="closeSupplierModal()" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Annuler
                            </button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Cr√©er le Fournisseur
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            // Charger les pays
            loadCountries('supplier_country');
            
            // G√©rer la soumission du formulaire
            modal.querySelector('#supplier-modal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await submitSupplierFromModal(modal);
            });
            
            return modal;
        }

        async function submitSupplierFromModal(modal) {
            const form = modal.querySelector('#supplier-modal-form');
            const formData = new FormData(form);
            
            const supplierData = {
                name: formData.get('name'),
                contact_person: formData.get('contact_person'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                country: formData.get('country'),
                city: formData.get('city'),
                address: formData.get('address')
            };

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/suppliers/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(supplierData)
                });

                if (response.ok) {
                    const newSupplier = await response.json();
                    showSuccess('Fournisseur cr√©√© avec succ√®s !');
                    closeSupplierModal();
                    loadSuppliers(); // Recharger la liste des fournisseurs
                } else {
                    const error = await response.json();
                    showError('Erreur: ' + (error.detail || 'Erreur inconnue'));
                }
            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion');
            }
        }

        function closeSupplierModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                modal.remove();
            }
        }

        async function loadServices() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/services/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const services = await response.json();
                    populateServicesSelect(services);
                } else {
                    console.error('Erreur lors du chargement des services');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des services:', error);
            }
        }

        function populateServicesSelect(services) {
            const select = document.getElementById('service_filter');
            select.innerHTML = '<option value="">S√©lectionnez un service pour voir ses demandes valid√©es...</option>';
            
            services.forEach(service => {
                if (service.is_active) {
                    const option = document.createElement('option');
                    option.value = service.name;
                    option.textContent = `${service.name} (${service.code})`;
                    select.appendChild(option);
                }
            });
        }

        async function loadValidatedRequests() {
            const serviceName = document.getElementById('service_filter').value;
            if (!serviceName) {
                document.getElementById('validated-requests-section').style.display = 'none';
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch('/api/purchase-requests/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const requests = await response.json();
                    const validatedRequests = requests.filter(request => 
                        request.department === serviceName && 
                        request.status === 'approved_by_purchase'
                    );
                    
                    displayValidatedRequests(validatedRequests);
                } else {
                    showError('Erreur lors du chargement des demandes');
                }
            } catch (error) {
                console.error('Erreur lors du chargement des demandes:', error);
                showError('Erreur de connexion');
            }
        }

        function displayValidatedRequests(requests) {
            const section = document.getElementById('validated-requests-section');
            const list = document.getElementById('validated-requests-list');
            
            if (requests.length === 0) {
                list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune demande valid√©e pour ce service.</p>';
                section.style.display = 'block';
                return;
            }

            let html = '<div style="display: grid; gap: 10px;">';
            requests.forEach(request => {
                html += `
                    <div style="
                        background: white; padding: 15px; border-radius: 8px; 
                        border: 1px solid #ddd; cursor: pointer;
                        transition: all 0.3s ease;
                    " onclick="selectRequestForPurchase(${request.id})" 
                       onmouseover="this.style.borderColor='#28a745'; this.style.boxShadow='0 2px 8px rgba(40,167,69,0.2)'"
                       onmouseout="this.style.borderColor='#ddd'; this.style.boxShadow='none'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h5 style="margin: 0 0 5px 0; color: #2c3e50;">${request.item_name}</h5>
                                <p style="margin: 0; color: #666; font-size: 14px;">
                                    Quantit√©: <strong>${request.quantity} ${request.unit}</strong> | 
                                    Urgence: <strong>${request.urgency}</strong>
                                </p>
                                <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">
                                    ${request.description || 'Aucune description'}
                                </p>
                                ${request.approved_by_dg_at ? `
                                <div style="margin-top: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px; border-left: 3px solid #28a745;">
                                    <p style="margin: 0; color: #28a745; font-size: 12px; font-weight: bold;">
                                        <i class="fas fa-signature"></i> Approuv√©e par le DG
                                    </p>
                                    <p style="margin: 2px 0 0 0; color: #666; font-size: 11px;">
                                        ${new Date(request.approved_by_dg_at).toLocaleString('fr-FR')}
                                    </p>
                                    ${request.dg_signature ? `
                                    <p style="margin: 5px 0 0 0; color: #28a745; font-size: 10px;">
                                        <i class="fas fa-check-circle"></i> Signature √©lectronique
                                    </p>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                            <div style="text-align: right;">
                                <span style="
                                    background: #28a745; color: white; padding: 4px 8px; 
                                    border-radius: 12px; font-size: 12px; font-weight: bold;
                                ">
                                    <i class="fas fa-check"></i> Valid√©e
                                </span>
                                <p style="margin: 5px 0 0 0; color: #999; font-size: 11px;">
                                    ${new Date(request.requested_at).toLocaleDateString('fr-FR')}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            list.innerHTML = html;
            section.style.display = 'block';
        }

        function selectRequestForPurchase(requestId) {
            // Charger les d√©tails de la demande
            const token = localStorage.getItem('access_token');
            fetch('/api/purchase-requests/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(requests => {
                const request = requests.find(r => r.id === requestId);
                if (request) {
                    // Pr√©-remplir le formulaire d'achat
                    document.getElementById('item_name').value = request.item_name;
                    document.getElementById('quantity').value = request.quantity;
                    document.getElementById('unit_price').value = ''; // L'utilisateur doit saisir le prix
                    document.getElementById('description').value = request.description || '';
                    
                    // Calculer le total automatiquement
                    document.getElementById('quantity').addEventListener('input', calculateTotal);
                    document.getElementById('unit_price').addEventListener('input', calculateTotal);
                    
                    showSuccess(`Demande "${request.item_name}" s√©lectionn√©e. Veuillez saisir le prix unitaire.`);
                    
                    // Faire d√©filer vers le formulaire
                    document.getElementById('purchase-form').scrollIntoView({ behavior: 'smooth' });
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                showError('Erreur lors du chargement de la demande');
            });
        }
    </script>
</body>
</html>
