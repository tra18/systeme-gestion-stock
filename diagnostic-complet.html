<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Complet - VITACH GUIN√âE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .code {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .step {
            border-left: 4px solid #007bff;
            padding-left: 15px;
            margin: 15px 0;
        }
        .step.success {
            border-left-color: #28a745;
        }
        .step.error {
            border-left-color: #dc3545;
        }
        .step.warning {
            border-left-color: #ffc107;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic Complet - VITACH GUIN√âE</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è Probl√®me d'acc√®s d√©tect√©</h3>
            <p>Cet outil va diagnostiquer pourquoi vous n'arrivez pas √† acc√©der au syst√®me.</p>
        </div>

        <div>
            <h3>üõ†Ô∏è Actions de diagnostic :</h3>
            <button class="btn" onclick="diagnosticComplet()">üîç Diagnostic Complet</button>
            <button class="btn btn-success" onclick="creerUtilisateurDG()">üëë Cr√©er Utilisateur DG</button>
            <button class="btn btn-warning" onclick="testerConnexion()">üîê Tester Connexion</button>
            <button class="btn btn-danger" onclick="nettoyerCache()">üóëÔ∏è Nettoyer Cache</button>
        </div>

        <div id="resultats"></div>
    </div>

    <div class="container">
        <h2>üìã Guide de r√©solution √©tape par √©tape</h2>
        
        <div class="step">
            <h3>√âtape 1 : V√©rifier l'√©tat actuel</h3>
            <p>Cliquez sur "Diagnostic Complet" pour voir l'√©tat de votre syst√®me.</p>
        </div>

        <div class="step">
            <h3>√âtape 2 : Cr√©er l'utilisateur DG</h3>
            <p>Si aucun utilisateur n'est configur√©, cliquez sur "Cr√©er Utilisateur DG".</p>
        </div>

        <div class="step">
            <h3>√âtape 3 : Tester la connexion</h3>
            <p>Utilisez "Tester Connexion" pour v√©rifier l'acc√®s aux pages.</p>
        </div>

        <div class="step">
            <h3>√âtape 4 : Nettoyer si n√©cessaire</h3>
            <p>En cas de probl√®me persistant, utilisez "Nettoyer Cache".</p>
        </div>
    </div>

    <div class="container">
        <h2>üîó Liens de test rapide</h2>
        <a href="/" class="btn">üè† Page d'accueil</a>
        <a href="/login" class="btn">üîê Page de connexion</a>
        <a href="/dashboard" class="btn">üìä Dashboard</a>
        <a href="/gestion-it" class="btn">üíª Gestion IT</a>
        <a href="/gestion-permissions" class="btn">‚öôÔ∏è Gestion Permissions</a>
    </div>

    <script>
        function diagnosticComplet() {
            const resultatsDiv = document.getElementById('resultats');
            resultatsDiv.innerHTML = '<div class="info">üîç Diagnostic en cours...</div>';

            let html = '<div class="container"><h3>üìä R√©sultats du diagnostic :</h3>';

            // 1. V√©rifier localStorage
            html += '<div class="step"><h4>1. üì± V√©rification du localStorage :</h4>';
            const userProfile = localStorage.getItem('userProfile');
            const currentUser = localStorage.getItem('currentUser');
            const firebaseAuth = localStorage.getItem('firebase:authUser');

            if (userProfile) {
                try {
                    const profile = JSON.parse(userProfile);
                    html += `<div class="success">‚úÖ Profil utilisateur trouv√© :</div>`;
                    html += `<div class="code">Email: ${profile.email || 'N/A'}<br>`;
                    html += `R√¥le: ${profile.role || 'N/A'}<br>`;
                    html += `Nom: ${profile.nom || 'N/A'}<br>`;
                    html += `Super Admin: ${profile.isSuperAdmin || false}</div>`;
                } catch (e) {
                    html += `<div class="error">‚ùå Erreur parsing profil: ${e.message}</div>`;
                }
            } else {
                html += '<div class="error">‚ùå Aucun profil utilisateur trouv√©</div>';
            }

            if (currentUser) {
                html += '<div class="success">‚úÖ Utilisateur actuel trouv√©</div>';
            } else {
                html += '<div class="error">‚ùå Aucun utilisateur actuel trouv√©</div>';
            }

            if (firebaseAuth) {
                html += '<div class="success">‚úÖ Session Firebase trouv√©e</div>';
            } else {
                html += '<div class="warning">‚ö†Ô∏è Aucune session Firebase trouv√©e</div>';
            }
            html += '</div>';

            // 2. V√©rifier les permissions
            html += '<div class="step"><h4>2. üîê V√©rification des permissions :</h4>';
            if (userProfile) {
                try {
                    const profile = JSON.parse(userProfile);
                    const isDG = profile.email === 'dg@gmail.com';
                    const isSuperAdmin = profile.isSuperAdmin;
                    
                    if (isDG || isSuperAdmin) {
                        html += '<div class="success">‚úÖ Acc√®s complet autoris√© (DG/Super Admin)</div>';
                    } else {
                        html += `<div class="warning">‚ö†Ô∏è R√¥le limit√©: ${profile.role}</div>`;
                    }
                } catch (e) {
                    html += `<div class="error">‚ùå Erreur v√©rification permissions: ${e.message}</div>`;
                }
            } else {
                html += '<div class="error">‚ùå Impossible de v√©rifier les permissions (pas de profil)</div>';
            }
            html += '</div>';

            // 3. V√©rifier la navigation
            html += '<div class="step"><h4>3. üß≠ Test de navigation :</h4>';
            const testPages = [
                { name: 'Dashboard', url: '/dashboard' },
                { name: 'Gestion IT', url: '/gestion-it' },
                { name: 'Gestion Permissions', url: '/gestion-permissions' },
                { name: 'Ressources Humaines', url: '/ressources-humaines' }
            ];

            testPages.forEach(page => {
                html += `<div>üìÑ ${page.name}: <a href="${page.url}" target="_blank">Tester</a></div>`;
            });
            html += '</div>';

            // 4. Recommandations
            html += '<div class="step"><h4>4. üí° Recommandations :</h4>';
            if (!userProfile) {
                html += '<div class="warning">‚ö†Ô∏è Cr√©ez un utilisateur DG pour avoir acc√®s complet</div>';
            } else {
                try {
                    const profile = JSON.parse(userProfile);
                    if (profile.email !== 'dg@gmail.com' && !profile.isSuperAdmin) {
                        html += '<div class="warning">‚ö†Ô∏è Votre utilisateur n\'a pas les privil√®ges DG</div>';
                    }
                } catch (e) {
                    html += '<div class="error">‚ùå Erreur analyse profil</div>';
                }
            }
            html += '</div>';

            html += '</div>';
            resultatsDiv.innerHTML = html;
        }

        function creerUtilisateurDG() {
            const resultatsDiv = document.getElementById('resultats');
            resultatsDiv.innerHTML = '<div class="info">üëë Cr√©ation de l\'utilisateur DG...</div>';

            const userProfile = {
                uid: 'dg-super-admin-' + Date.now(),
                nom: 'Directeur G√©n√©ral',
                prenom: 'DG',
                email: 'dg@gmail.com',
                role: 'dg',
                poste: 'Directeur G√©n√©ral',
                permissions: 'all',
                isSuperAdmin: true,
                createdAt: new Date().toISOString(),
                isTestUser: true
            };

            const currentUser = {
                uid: userProfile.uid,
                email: 'dg@gmail.com',
                displayName: 'Directeur G√©n√©ral',
                isTestUser: true
            };

            try {
                localStorage.setItem('userProfile', JSON.stringify(userProfile));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('firebase:authUser', JSON.stringify({
                    uid: userProfile.uid,
                    email: 'dg@gmail.com',
                    displayName: 'Directeur G√©n√©ral',
                    emailVerified: true,
                    isAnonymous: false,
                    providerData: [{
                        providerId: 'password',
                        uid: 'dg@gmail.com',
                        email: 'dg@gmail.com',
                        displayName: 'Directeur G√©n√©ral'
                    }]
                }));

                resultatsDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Utilisateur DG cr√©√© avec succ√®s !</h3>
                        <p><strong>Email :</strong> dg@gmail.com</p>
                        <p><strong>R√¥le :</strong> dg (Super Admin)</p>
                        <p><strong>Acc√®s :</strong> Complet √† toutes les fonctionnalit√©s</p>
                        <p><strong>Prochaine √©tape :</strong> Allez sur l'application principale</p>
                    </div>
                `;
            } catch (error) {
                resultatsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur lors de la cr√©ation</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function testerConnexion() {
            const resultatsDiv = document.getElementById('resultats');
            resultatsDiv.innerHTML = '<div class="info">üîê Test de connexion en cours...</div>';

            const userProfile = localStorage.getItem('userProfile');
            
            if (!userProfile) {
                resultatsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Aucun utilisateur configur√©</h3>
                        <p>Cr√©ez d'abord un utilisateur DG avec le bouton "Cr√©er Utilisateur DG"</p>
                    </div>
                `;
                return;
            }

            try {
                const profile = JSON.parse(userProfile);
                const isDG = profile.email === 'dg@gmail.com';
                
                let html = '<div class="success"><h3>‚úÖ Test de connexion r√©ussi</h3>';
                html += `<p><strong>Utilisateur :</strong> ${profile.nom} (${profile.email})</p>`;
                html += `<p><strong>R√¥le :</strong> ${profile.role}</p>`;
                
                if (isDG || profile.isSuperAdmin) {
                    html += '<p><strong>Acc√®s :</strong> Complet √† toutes les fonctionnalit√©s</p>';
                    html += '<div class="info">üéØ Vous pouvez maintenant acc√©der √† toutes les pages :</div>';
                    html += '<ul>';
                    html += '<li>‚úÖ Dashboard</li>';
                    html += '<li>‚úÖ Gestion IT</li>';
                    html += '<li>‚úÖ Gestion Permissions</li>';
                    html += '<li>‚úÖ Toutes les autres pages</li>';
                    html += '</ul>';
                } else {
                    html += '<p><strong>Acc√®s :</strong> Limit√© selon le r√¥le</p>';
                }
                
                html += '</div>';
                resultatsDiv.innerHTML = html;
                
            } catch (error) {
                resultatsDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Erreur lors du test</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function nettoyerCache() {
            if (confirm('√ätes-vous s√ªr de vouloir nettoyer tout le cache ? Cela vous d√©connectera.')) {
                localStorage.clear();
                sessionStorage.clear();
                
                const resultatsDiv = document.getElementById('resultats');
                resultatsDiv.innerHTML = `
                    <div class="info">
                        <h3>üóëÔ∏è Cache nettoy√©</h3>
                        <p>Le cache a √©t√© vid√©. Vous devez maintenant cr√©er un nouvel utilisateur.</p>
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }

        // Diagnostic automatique au chargement
        window.onload = function() {
            setTimeout(diagnosticComplet, 1000);
        };
    </script>
</body>
</html>
