<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur de Codes PIN - Pointage Mobile</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .info-box {
            background: #e0f2fe;
            border-left: 4px solid #0284c7;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #0369a1;
            margin-bottom: 10px;
        }

        .info-box ul {
            color: #075985;
            margin-left: 20px;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .option-card.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .option-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .option-card p {
            color: #666;
            font-size: 0.9em;
        }

        .pin-length {
            margin-bottom: 20px;
        }

        .pin-length label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .pin-length input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.6);
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        .btn-secondary:hover {
            background: #f0f4ff;
        }

        .results {
            display: none;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .results.show {
            display: block;
        }

        .results h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .result-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item.error {
            border-left-color: #ef4444;
        }

        .result-item.warning {
            border-left-color: #f59e0b;
        }

        .result-name {
            font-weight: 600;
            color: #333;
        }

        .result-pin {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .status {
            padding: 10px 20px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .status.error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-small {
            padding: 10px 20px;
            font-size: 0.9em;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë G√©n√©rateur de Codes PIN</h1>
        <p class="subtitle">Syst√®me de pointage mobile par QR Code universel</p>

        <div class="info-box">
            <h3>üìã √Ä propos</h3>
            <p>Ce script g√©n√®re automatiquement des codes PIN uniques pour tous vos employ√©s actifs.</p>
            <ul>
                <li>Les employ√©s ayant d√©j√† un code PIN seront ignor√©s (sauf si vous choisissez de r√©g√©n√©rer)</li>
                <li>Les codes PIN sont g√©n√©r√©s al√©atoirement et sont uniques</li>
                <li>Vous pourrez exporter la liste pour communiquer les codes aux employ√©s</li>
            </ul>
        </div>

        <div class="options">
            <div class="option-card selected" id="option-new" onclick="selectOption('new')">
                <h4>‚ú® Nouveaux employ√©s uniquement</h4>
                <p>G√©n√®re un code PIN seulement pour les employ√©s qui n'en ont pas encore</p>
            </div>
            <div class="option-card" id="option-all" onclick="selectOption('all')">
                <h4>üîÑ R√©g√©n√©rer tous les codes</h4>
                <p>G√©n√®re de nouveaux codes PIN pour TOUS les employ√©s (remplace les anciens)</p>
            </div>
        </div>

        <div class="pin-length">
            <label for="pinLength">Longueur du code PIN (4-6 chiffres)</label>
            <input type="number" id="pinLength" min="4" max="6" value="4" />
        </div>

        <div class="status" id="status"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>G√©n√©ration en cours...</p>
        </div>

        <div class="buttons">
            <button class="btn btn-primary" id="generateBtn" onclick="generatePINs()">
                üöÄ G√©n√©rer les codes PIN
            </button>
            <button class="btn btn-secondary" onclick="location.reload()">
                üîÑ Recommencer
            </button>
        </div>

        <div class="results" id="results">
            <h3>‚úÖ Codes PIN g√©n√©r√©s</h3>
            <div id="resultsList"></div>
            
            <div class="export-buttons">
                <button class="btn btn-primary btn-small" onclick="exportToCSV()">
                    üì• Exporter CSV
                </button>
                <button class="btn btn-secondary btn-small" onclick="copyToClipboard()">
                    üìã Copier tout
                </button>
                <button class="btn btn-secondary btn-small" onclick="printList()">
                    üñ®Ô∏è Imprimer
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.9.0/firebase-app.js';
        import { getFirestore, collection, getDocs, updateDoc, doc } from 'https://www.gstatic.com/firebasejs/9.9.0/firebase-firestore.js';

        // Configuration Firebase (utilisez la m√™me que dans votre application)
        const firebaseConfig = {
            apiKey: "AIzaSyDE-TBWNZ_Y4WdPHaezRXIf1vizPEralVY",
            authDomain: "stock-bcbd3.firebaseapp.com",
            projectId: "stock-bcbd3",
            storageBucket: "stock-bcbd3.appspot.com",
            messagingSenderId: "901950451449",
            appId: "1:901950451449:web:stock-bcbd3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let selectedOption = 'new';
        let generatedPINs = [];

        window.selectOption = function(option) {
            selectedOption = option;
            document.getElementById('option-new').classList.remove('selected');
            document.getElementById('option-all').classList.remove('selected');
            document.getElementById('option-' + option).classList.add('selected');
        };

        function generatePIN(length) {
            const min = Math.pow(10, length - 1);
            const max = Math.pow(10, length) - 1;
            return Math.floor(min + Math.random() * (max - min + 1)).toString();
        }

        function ensureUniquePIN(existingPINs, length) {
            let pin;
            let attempts = 0;
            do {
                pin = generatePIN(length);
                attempts++;
                if (attempts > 1000) {
                    throw new Error('Impossible de g√©n√©rer un PIN unique apr√®s 1000 tentatives');
                }
            } while (existingPINs.includes(pin));
            return pin;
        }

        window.generatePINs = async function() {
            const pinLength = parseInt(document.getElementById('pinLength').value);
            
            if (pinLength < 4 || pinLength > 6) {
                showStatus('La longueur du PIN doit √™tre entre 4 et 6 chiffres', 'error');
                return;
            }

            // D√©sactiver le bouton et afficher le chargement
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loading').classList.add('show');
            document.getElementById('status').classList.remove('show');
            document.getElementById('results').classList.remove('show');
            generatedPINs = [];

            try {
                // R√©cup√©rer tous les employ√©s
                const employesSnapshot = await getDocs(collection(db, 'employes'));
                
                if (employesSnapshot.empty) {
                    showStatus('Aucun employ√© trouv√© dans la base de donn√©es', 'error');
                    return;
                }

                const employes = [];
                const existingPINs = [];

                employesSnapshot.forEach(doc => {
                    const data = doc.data();
                    employes.push({ id: doc.id, ...data });
                    if (data.codePIN && selectedOption === 'new') {
                        existingPINs.push(data.codePIN);
                    }
                });

                // Filtrer selon l'option choisie
                let employesToProcess = employes.filter(e => e.statut === 'actif');
                
                if (selectedOption === 'new') {
                    employesToProcess = employesToProcess.filter(e => !e.codePIN);
                    
                    if (employesToProcess.length === 0) {
                        showStatus('Tous les employ√©s actifs ont d√©j√† un code PIN !', 'warning');
                        document.getElementById('loading').classList.remove('show');
                        document.getElementById('generateBtn').disabled = false;
                        return;
                    }
                }

                // G√©n√©rer les PINs
                let successCount = 0;
                let errorCount = 0;

                for (const employe of employesToProcess) {
                    try {
                        const pin = ensureUniquePIN(existingPINs, pinLength);
                        existingPINs.push(pin);

                        await updateDoc(doc(db, 'employes', employe.id), {
                            codePIN: pin,
                            codePINGeneratedAt: new Date()
                        });

                        generatedPINs.push({
                            nom: employe.nom,
                            prenom: employe.prenom || '',
                            poste: employe.poste || '',
                            departement: employe.departement || '',
                            email: employe.email || '',
                            pin: pin,
                            success: true
                        });

                        successCount++;
                    } catch (error) {
                        console.error(`Erreur pour ${employe.nom}:`, error);
                        generatedPINs.push({
                            nom: employe.nom,
                            prenom: employe.prenom || '',
                            pin: 'ERREUR',
                            success: false,
                            error: error.message
                        });
                        errorCount++;
                    }
                }

                // Afficher les r√©sultats
                displayResults();
                
                const message = `‚úÖ ${successCount} code(s) PIN g√©n√©r√©(s) avec succ√®s${errorCount > 0 ? ` - ${errorCount} erreur(s)` : ''}`;
                showStatus(message, errorCount > 0 ? 'warning' : 'success');

            } catch (error) {
                console.error('Erreur:', error);
                showStatus('Erreur lors de la g√©n√©ration: ' + error.message, 'error');
            } finally {
                document.getElementById('loading').classList.remove('show');
                document.getElementById('generateBtn').disabled = false;
            }
        };

        function displayResults() {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            generatedPINs.forEach(item => {
                const div = document.createElement('div');
                div.className = 'result-item' + (item.success ? '' : ' error');
                div.innerHTML = `
                    <div class="result-name">
                        ${item.nom} ${item.prenom}
                        ${item.poste ? `<br><small style="color: #666;">${item.poste}</small>` : ''}
                    </div>
                    <div class="result-pin">${item.pin}</div>
                `;
                resultsList.appendChild(div);
            });

            document.getElementById('results').classList.add('show');
        }

        function showStatus(message, type = 'success') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show ' + type;
        }

        window.exportToCSV = function() {
            let csv = 'Nom,Pr√©nom,Poste,D√©partement,Email,Code PIN\n';
            
            generatedPINs.forEach(item => {
                if (item.success) {
                    csv += `"${item.nom}","${item.prenom}","${item.poste}","${item.departement}","${item.email}","${item.pin}"\n`;
                }
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `codes_pin_${new Date().toISOString().split('T')[0]}.csv`);
            link.click();
        };

        window.copyToClipboard = function() {
            let text = 'CODES PIN - POINTAGE MOBILE\n';
            text += '=' .repeat(50) + '\n\n';
            
            generatedPINs.forEach(item => {
                if (item.success) {
                    text += `${item.nom} ${item.prenom}\n`;
                    text += `Poste: ${item.poste}\n`;
                    text += `Code PIN: ${item.pin}\n`;
                    text += '-'.repeat(50) + '\n\n';
                }
            });

            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Liste copi√©e dans le presse-papiers !');
            });
        };

        window.printList = function() {
            const printWindow = window.open('', '_blank');
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Codes PIN - Pointage Mobile</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; text-align: center; }
                        .date { text-align: center; color: #666; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                        th { background: #667eea; color: white; }
                        .pin { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.2em; color: #667eea; }
                        @media print { button { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üì± Codes PIN - Pointage Mobile</h1>
                    <p class="date">G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Pr√©nom</th>
                                <th>Poste</th>
                                <th>Code PIN</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            generatedPINs.forEach(item => {
                if (item.success) {
                    html += `
                        <tr>
                            <td>${item.nom}</td>
                            <td>${item.prenom}</td>
                            <td>${item.poste}</td>
                            <td class="pin">${item.pin}</td>
                        </tr>
                    `;
                }
            });

            html += `
                        </tbody>
                    </table>
                    <script>
                        window.onload = function() {
                            setTimeout(() => window.print(), 500);
                        };
                    </script>
                </body>
                </html>
            `;

            printWindow.document.write(html);
            printWindow.document.close();
        };
    </script>
</body>
</html>

